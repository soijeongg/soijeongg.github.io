---
layout: post
read_time: true
show_date: true
title: "실전 카프카 카프카 3장 개념과 구조"
date: 2024-05-03 15:00:20 -0600
description: "실전 카프카 카프카 3장 개념과 구조"
image: https://i.pinimg.com/474x/75/53/44/7553448fcd453fa719a5592a34626d90.jpg
tags: 
    - coding
    - diary
   
author: soi

toc: no # leave empty or erase for no TOC
---

### 카프카 기초 다지기
- 카프카를 구성하는 주요 요소 
주키퍼: 아파치 프로젝트의 애플리케이션의 이름, 카프카의 메타데이터 관리 및 브로커의 정상상태 점검 담당
카프카 or 카프카 클러스터: 아파치 프로젝트의 애플리케이션 이름, 여러대의 브로커를 구성한 클러스터를 의미
프로듀서: 카프카에서 메시지를 보내는 역할을 하는 클라이언트를 총칭
컨슈머: 카프카에서 메시지를 꺼내는 역할을 하는 클라이언트 총칭
토픽: 카프카는 메시지들을 토픽으로 구분하고 각 토픽의 이름은 카프카 내에서 고유함
파티션: 병렬처리 및 고성능을 얻기 위해 하나의 토픽을 여러개로 나눈것을 말함
세그먼트: 프로듀서가 전송한 실제 메시지가 브러카의 로컬 디스크에 정되는 파일
메시지: 프로듀서가 브로커로 전송하거나 컨슈머가 읽어가는 데이터 조각을 말함

### 카프카란
카프카란 링크드인에서 개발된 메시지큐 방식을 기반으로 한 분산 메시지 시스템
카프카는 pub-sub 모델을 기반으로 프로듀서(퍼블리셔), 컨슈머(서브스크리버)
카프카의 동작원리
- 프로듀서는 전달하고자 하는 메시지를 토픽을 통해 카테고리화함
- 컨슈머는 원하는 토픽을 구독함으로써 메시지를 읽어옴
- 퍼블리셔와 컨슈머는 오로지 토픽 정보만 알뿐 서로에 대해 알지 못한다 
- 클러스터 내 브로커에 대한 분산처리는 주키퍼가 담당한다


#### 리플리케이션
각 메시지들을 여러개로 복제해서 카프카 클러스터 내 브로커들에 분산시키는 동작을 의미
이러한 리플리케이션 동작 덕분에 하나의 브로커가 종료되더라도 카프카는 안정성을 유지 할 수 있습니다 
--partition 1, --replication-factor 3이라는 옵션을 사용해 토픽을 만들 수 있음
정확히 말하면 ㅋ타프카에서 토픽이 리플리케이션이 되는게 아니라 토픽의 파티션이 리플리케이션 되는것
안정성을 목적으로 모든 토픽에 대해 각 3대의 리플리케이션으로 설정 할 수 있다 
리플리케이션의 펙터 수가 커지면 안정성은 높아지지만 그만큼 브로커의 리소스를 많이 사용하게 됨
따라서 복제에 대한 오버해드를 줄여서 최대한 브로커 리소스를 많이 사용하게 됨

보통 토칙 생성시 다음과 같은 기준을 세워두고 리플리케이션 팩터 수를 설정해 사용한다면 좀더 효율적으로 운용가능
- 테스트나 개발환경: 리플리케이션 팩터 수 1로 설정
- 운영환경(로그성 메시지로서 약간의 유실헝요): 리플리케이션 ㅍ책터수를 2로 설정
물론 안정성을 더욱 높이고자 하는 경우 리플리케이션 팩터를 그 이상으로 할 수도 있음ㅇ

#### 파티션
하나의 토픽이 한번에 처리할 수 있는 한계를 높이기 위해 토픽 하나를 여러개로 나눠 병렬 처리가 가능하게 만든것을 파티션이라고 한다 
파티션 번호는 0번부터 시작
파티션을 정하는 기준은 다소 모호한 경우가 많음 특히 파티션은 초기 생성 후 언제든지 늘릴 수 있지만 다시 줄이지는 못한다는 점을 명심
초기에는 조금 작게 설정후 메시지 수와 컨슈머의 LAG를 모니터링 해 조금씩 늘려가는 방법이 가장좋음
(컨슈머의 LAG란 프로듀서가보낸 메시지수-컨슈머가 가져간 메시지 수 )
lag라는 지표는 컨슈머에 지연이 없는지 확인 할 수 있음

#### 세그먼트
프로듀서를 이용해 카르카의 토픽으로 메시지를 전송했고 컨슈머를 이용해 메시지를 읽을 수 있음
그리고 카푸카에서는 각 메시지들을 저장함
각 프로듀서에 의해 브로커로 전송된 메시지는 토픽의 파티션에 저장되며 각 메시지는 세크먼트라는 로그 파일의 형태로 로컬 디스크애 저장
브로커의 세그먼트 로그 파일에 저장된 메시지를 컨슘가 읽어갈 수 있음

### 카프카의 기본개념
- 분산 시스템
분산 시스템이란 네트워크 상에서 연결된 컴퓨터들의 그룹을 말하며 단일 시스템이 갖지 못한 높은 성능이 목표
분산시스템은 성능이 높다는 장점 이외에도 하나의 서버 노드에서 장애가 발생할 시 다른 서버나 노드가 대신 처리하기 때문에 장애 대응에 탁월하며 부하가 높은 경우에는 서버 확장이 용이 하다는 장점이 있습니다
리소스가 한계에 도달해 더욱 높은 메세지 처리량이 필요한 경우 브로커를 추가하는 방향으로 확장이 가능 

- 페이지 캐시 
카프카는 높은 처리량을 얻기 위해 페이지 캐시 기능 추가 
운영체제는 성능을 높이기 위해 꾸준히 갱신되고 있는데 페이지 캐시 활용이 대표적
카프카 역시 os의 페이지 캐시를 활용하는 방식으로 설계됨
페이지 캐시는 직접 디스크를 읽는 대신 메모리 애플리케이션 중 사용하지 않는 일부 잔여 메모리 활용

- 배치 전송처리
카프카는 프로듀서, 컨슈머 클라이언트들과 소통하며 이들 사이에 수많은 메시지를 주고 받음
이때 발생하는 수많은 통신을 묶어서 처리 할 수 있다면 단건으로 통신할때에 비해 네트워크 오버레드를 줄일 수 있을 뿐만 아니라 더욱 빠르고 효율적으로 처리 할 수 있음

상품의 재고 수량 업데이트 작업은 지연없이 실시간으로 처리되어야 하지만 구매로그를 저장소로 보내는 작업은 이미 로그가 서버에 저장되어 있으므로 배치처리가 효율적

- 압축전송
카프카는 메시지 전송시 성능이 더 높은 압축 전송을 사용하는 것을 권장
압축만으로도 네트워크 대역폭이나 회선비용들을 줄일 수 있음

### 토픽, 파티션, 오프셋
카프카는 토픽에 데이터 저장 이메일 주소 정도의 개념으로 이해하면 쉬움
이 토픽은 병렬처리가 가능한 파티션으로 나뉨
파티션의 메시지가 저장도히는 위치를 오프셋 순차적으로 증거하는 숫자로 되어 있음
각 파티션에서 오프셋은 고유한 숫자로 카프카에사 오프셋을 통해 메시지의 순서를 보장하고 컨슈머에서는 마지막까지 읽은 위치 알 수 있음

### 고가용성 보장
카프카는 분산서비스이기 때문에 하나의 서버나 노드가 다운되더라도 다른 서버또는 노드가 장애가 발생한 서버의 역할을 대신해 안정적인 서비스가 가능
고가용성을 보장하기; 위해 카프카에서는 리플리케이션 기능을 제공
카프카의 토픽 자체를 복사하는 것이 아니라 토픽의 파티션을 복사하는 것 
원본과 리플리케이션을 구분하기 위해 카프카에서는 리더와 팔로워라고 부름
리더의 숫자는 1로 고정하고 리플리케이션의 팩터의 수에 따라 팔로워만 증가 
하지만 팔로워 수가 많다고 좋은것도 아님 -> 팔로워 수 만큼 결국 브롷커의 디스크 공간도 소비되므로 딱히 이상적인 리플리케이션 팩터를 유지해야함 일반적으로는 3
리더는 프로듀서, 컨슈머로 오는 모든 읽기와 쓰기 요창을 처리하며 팔로워는 오직리더로부터 리플리케이션 하게 됨

### 주키퍼의 의존성
주키퍼는 어러대의 서버를 앙상블로 구성하고 살아있는 노드 수가 과반수 이상이 유지된다면 지속적으로 서비스가 가능한 구조
따라서 주키퍼가 반드시 홀수가 되어야 함
지노드를 통해 카프카의 메타데이터가 주키퍼에 기록되며 주키퍼는 이러한 지노드를 이용해 브로커의 노드 관리 ,토픽관리,컨트롤러 관리등 매우 중요한 역할을 하고 있음
하지만 최근들어 카프카가 점점 성장하면서 주키퍼 성능의 한계가 드러나기 시작
주키퍼의 한계에서 벗어나고자 카프카에서 주키퍼에 대한 의존성을 제거하려는 움직임이 진행중
현재 버전 카프카는 주키퍼가 탑제되어 있음

## 프로듀서의 기본동작과 예제

프로듀서는 여러 옵션을 제공하므로 원하는 형태에 따라 옵션을 변경하면서 다양한 방법으로 카프카로 메시지를 전송할 수 있음
### 프로듀서 디자인
![](https://velog.velcdn.com/images%2Ffj2008%2Fpost%2Fa077c9ad-e0e2-4679-9755-2c2c46176b9d%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-06%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%2011.39.45.png)
프로로듀서가 카프카로 레코드를 전송할때 카프카의 특정 토픽으로 메시지를 전송
레코드에서 토픽과 벨류(메시지 내용)은 필수값
특정 파티션을 지정하기 위한 레코드의 파티션과 특정 파티션의 레코드를 정렬하기 위한 레코드의 키는 필숫값이 아닌 선택사항