---
layout: post
read_time: true
show_date: true
title: "[ë°ë¸Œìº í”„]nest.js ê³µì‹ë¬¸ì„œ -ë³´ì•ˆ"
date: 2024-02-28 15:00:20 -0600
description: "[ë°ë¸Œìº í”„]nest.js ê³µì‹ë¬¸ì„œ -ë³´ì•ˆ"
image: ../assets/img/uploads/nestr.png
tags: 
    - coding
    - diary
    - hh99
author: soi

toc: no # leave empty or erase for no TOC
---

### ì¸ì¦
ì„œë²„ëŠ” ì¸ì¦ì„ ì¦ëª…í•˜ê¸° ìœ„í•´ í›„ì†ìš”ì²­ì‹œ ì¸ì¦í—¤ë”ì— ì „ë‹¬ì í† í°ìœ¼ë¡œ ì „ì†¡ë  ìˆ˜ ìˆëŠ” jwt ë°œí–‰
ë˜í•œ ìœ íš¨í•œ jwtê°€ í¬í•¨ëœ ìš”ì²­ì—ë§Œ ì—‘ì„¸ìŠ¤ í•  ìˆ˜ ìˆëŠ” ë³´í˜¸ëœ ê²½ë¡œ ìƒì„±

### ì¸ì¦ëª¨ë“ˆ ìƒì„±
authmodule,AuthService, AuthControllerì„ ì‹¤í–‰í•˜ëŠ” ê²ƒë¶€í„° ì‹œì‘
```shell
$ nest g module auth
$ nest g controller auth
$ nest g service auth
```
### ë¡œê·¸ì¸ ëì  êµ¬í˜„
AuthServiceì—ì„œ ì‚¬ìš©ìë¥¼ ê²€ìƒ‰í•˜ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ëŠ” ì‘ì—…ì„ ì§„í–‰
ì„œë¹„ìŠ¤íŒŒì¼ì— ë¡œê·¸ì¸ í•˜ê¸° ìœ„í•œ í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤ 
```typescript
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { UsersService } from '../users/users.service';

@Injectable()
export class AuthService {
  constructor(private usersService: UsersService) {}

  async signIn(username: string, pass: string): Promise<any> {
    const user = await this.usersService.findOne(username);
    if (user?.password !== pass) {
      throw new UnauthorizedException();
    }
    const { password, ...result } = user;
    // TODO: Generate a JWT and return it here
    // instead of the user object
    return result;
  }
}
```
ì—¬ê¸°ì— ìˆëŠ” ìœ ì € ì„œë¹„ìŠ¤ì—ì„œ í•œëª… ê²€ìƒ‰í•˜ëŠ”ê±¸ ê°€ì ¸ì™€ 
```typescript
 async findOne(username: string): Promise<User | undefined> {
    return this.users.find(user => user.username === username);
```
ê²€ìƒ‰í•˜ê³  í™•ì¸

### jwt
ì¸ì¦ì‹œìŠ¤í…œì„ jwt ì‚¬ìš©
```shell
npm install --save @nestjs/jwt
```
jwtë¥¼ ë°œí–‰í•˜ëŠ” ì½”ë“œë¥¼ ì„œë¹„ìŠ¤ê³„ì¸µì— ì¶”ê°€í•œë‹¤ 
```typescript

import { Injectable, UnauthorizedException } from '@nestjs/common';
import { UsersService } from '../users/users.service';
import { JwtService } from '@nestjs/jwt';

@Injectable()
export class AuthService {
  constructor(
    private usersService: UsersService,
    private jwtService: JwtService
  ) {}

  async signIn(
    username: string,
    pass: string,
  ): Promise<{ access_token: string }> {
    const user = await this.usersService.findOne(username);
    if (user?.password !== pass) {
      throw new UnauthorizedException();
    }
    const payload = { sub: user.userId, username: user.username };
    return {
      access_token: await this.jwtService.signAsync(payload),
    };
  }
}
```
ë§¨ ë°‘ì— jwtë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‚¬ìš© 
authí´ë”ì— contants.tsì„ ë§Œë“¤ì–´ jwtì„¤ì •ì„ ìœ„í•œ ìƒìˆ˜ì •ì˜
```typescript
export const jwtConstants = {
  secret: 'yourSecretKey',  // ì—¬ê¸°ì— ë‹¹ì‹ ì˜ ë¹„ë°€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”
};
```
dlgn authmoduleì„ ì—…ë°ì´íŠ¸ í•´ í•„ìš”í•œ ì˜ì¡´ì„±ì„ ê°€ì ¸ì˜¤ê³  jwtmodule ì„¤ì •
```typescript
import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { AuthService } from './auth.service';
import { UsersModule } from '../users/users.module';
import { jwtConstants } from './constants';
import { JwtStrategy } from './jwt.strategy';

@Module({
  imports: [
    PassportModule,
    JwtModule.register({
      secret: jwtConstants.secret,
      signOptions: { expiresIn: '60s' },
    }),
    UsersModule,
  ],
  providers: [AuthService, JwtStrategy],
  exports: [AuthService],
})
export class AuthModule {}
```
### jwt ê²€ì¦
jwtê²€ì¦í•˜ê¸° ìœ„í•´ ê²€ì¦ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„
```typescript
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { jwtConstants } from './constants';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: jwtConstants.secret,
    });
  }

  async validate(payload: any) {
    return { userId: payload.sub, username: payload.username };
  }
}
```
### ì¸ì¦ê°€ë“œ êµ¬í˜„
ê²½ë¡œë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ ì¸ì¦ê°€ë“œë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ ì¸ì¦ê°€ë“œ êµ¬í˜„
auth.guards.tsë¥¼ ë§Œë“  ë‹¤ìŒ
```typescript

import {
  CanActivate,
  ExecutionContext,
  Injectable,
  UnauthorizedException,
} from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { jwtConstants } from './constants';
import { Request } from 'express';

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private jwtService: JwtService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const token = this.extractTokenFromHeader(request);
    if (!token) {
      throw new UnauthorizedException();
    }
    try {
      const payload = await this.jwtService.verifyAsync(
        token,
        {
          secret: jwtConstants.secret
        }
      );
      // ğŸ’¡ We're assigning the payload to the request object here
      // so that we can access it in our route handlers
      request['user'] = payload;
    } catch {
      throw new UnauthorizedException();
    }
    return true;
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? [];
    return type === 'Bearer' ? token : undefined;
  }
}
```
ë³´í˜¸í•˜ê³  ì‹¶ì€ ì»¨íŠ¸ë¡¤ëŸ¬ì— ê°€ì„œ ì ìš©í•œë‹¤ 
```typescript
@UseGuards(AuthGuard)
  @Get('profile')
  getProfile(@Request() req) {
    return req.user;
```
